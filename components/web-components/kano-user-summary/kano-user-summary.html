<link rel="import" href="../../polymer/polymer.html">

<!--

`kano-user-summary` is a simple thumbnail user display for the kano-nav

Example:

    <kano-user-summary user="[[user]]"></kano-user-summary>
    <kano-user-summary user="[[user]]" default-avatar="/my-default-avatar.png"></kano-user-summary>

@group Kano Elements
@hero hero.svg
@demo ./kano-user-summary/demo/kano-user-summary.html
-->
<dom-module is="kano-user-summary">
    <style>
        :host {
            --light-yellow: #ffb300;
            --mid-yellow: #f3a427;
            --dark-yellow: #b37e00;
            --dark-grey: #333333;
            display: block;
            box-sizing: border-box;
            font-size: 14px;
            height: 100%;
        }
        :host * {
            box-sizing: border-box;
        }
        :host .content {
            @apply(--layout-flex);
            @apply(--layout-horizontal);
            @apply(--layout-justified);
            height: 100%;
        }
        :host .thumbnail {
            height: 100%;
        }
        :host .avatar {
            height: auto;
            max-height: 100%;
            max-width: 40px;
            width: 100%;
        }
        :host .user {
            @apply(--layout-flex);
            @apply(--layout-vertical);
            @apply(--layout-around-justified);
            padding-left: 20px;
        }
        :host .user-main {
            @apply(--layout-flex-2);
            @apply(--layout-horizontal);
            @apply(--layout-justified);
            @apply(--layout-end);
            color: var(--dark-grey);
            width: 100%;
        }
        :host .username {
            font-weight: bold;
            padding-right: 35px;
        }
        :host .level {
            font-weight: lighter;
            text-transform: uppercase;
        }
        :host .user-main {
            width: 100%;
        }
        :host .user-progress {
            @apply(--layout-flex);
            @apply(--layout-vertical);
            @apply(--layout-start-justified);
            padding-top: 3px;
        }
        :host .progress-container {
            background-color: #c7c7c7;
            border-radius: 3px;
            height: 6px;
            position: relative;
            width: 100%;
        }
        :host .progress-bar {
            border-bottom: 3px solid var(--mid-yellow);
            border-radius: 3px;
            border-top: 3px solid var(--light-yellow);
            height: 0;
            transition: 0.3s ease width;
            width: 0%
        }
        :host .progress-overlay {
            background-color: #333333;
            border-radius: 6px;
            bottom: 0;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            display: none;
            left: 3px;
            max-width: 200px;
            min-width: 120px;
            padding: 15px 20px;
            position: absolute;
            transform: translate(-50%, 130%);
        }
        :host .user-progress:focus .progress-overlay,
        :host .user-progress:hover .progress-overlay {
            @apply(--layout-flex);
            @apply(--layout-horizontal);
            @apply(--layout-start);
        }
        :host .progress-overlay::before {
            background-color: var(--dark-grey);
            content: '';
            height: 10px;
            left: 0;
            margin: auto;
            position: absolute;
            right: 0;
            top: -5px;
            transform: rotate(45deg);
            width: 10px;
            z-index: -1;
        }
        :host .progress-prefix {
            @apply(--layout-flex-none);
            vertical-align: top;
        }
        :host .prefix-icon {
            width: 20px;
        }
        :host .icon-light{
            fill: var(--light-yellow);
        }
        :host .icon-dark{
            fill: var(--dark-yellow);
        }
        :host .progress-text {
            @apply(--layout-flex-auto);
            line-height: 1em;
            padding-left: 10px;
            text-align: left;
        }
        :host .current-progress {
            color: #ffffff;
        }
        :host .required-progress {
            color: #999999;
            font-size: 0.8em;
        }
        @media all and (max-width: 768px) {
            :host .user {
                display: none;
            }
        }
    </style>
    <template>
        <div class="content">
            <div class="thumbnail">
                <img src="[[avatar]]" class="avatar" />
            </div>
            <div class="user">
                <div class="user-main">
                    <div class="username">
                      [[user.username]]
                    </div>
                    <div class="level">
                      lv [[level]]
                    </div>
                </div>
                <div class="user-progress">
                    <div class="progress-container">
                        <div class="progress-bar" style$="[[_computeProgressBarStyle(progress)]]"></div>
                        <div class="progress-overlay" style$='[[_computeProgressOverlayStyle(progress)]]'>
                          <div class="progress-prefix">
                              <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                   viewBox="0 0 31.3 24.6" style="enable-background:new 0 0 31.3 24.6;" xml:space="preserve" class="prefix-icon">
                                  <g>
                                      <g>
                                          <path class="icon-light" d="M27.6,0H3.7C1.7,0,0,1.7,0,3.7v17.1c0,2.1,1.7,3.7,3.7,3.7h23.9c2.1,0,3.7-1.7,3.7-3.7V3.7
                                              C31.3,1.7,29.7,0,27.6,0z"/>
                                          <g>
                                              <path class="icon-dark" d="M11.6,14l-2.7,4.1c-0.2,0.3-0.5,0.5-0.9,0.5c-0.6,0-1-0.5-1-1c0-0.2,0.1-0.4,0.2-0.6l3.3-4.7L7.4,7.9
                                                  C7.2,7.7,7.2,7.5,7.2,7.3c0-0.6,0.5-1,1-1c0.4,0,0.6,0.1,0.8,0.4l2.5,3.8L14,6.7c0.2-0.3,0.5-0.4,0.8-0.4c0.6,0,1,0.5,1,1
                                                  c0,0.2-0.1,0.4-0.2,0.6l-3.1,4.4l3.3,4.7c0.1,0.1,0.2,0.3,0.2,0.6c0,0.6-0.5,1-1,1c-0.4,0-0.6-0.2-0.9-0.5L11.6,14z"/>
                                              <path class="icon-dark" d="M19.5,13.7v3.8c0,0.6-0.5,1-1,1s-1-0.5-1-1V7.4c0-0.6,0.5-1,1-1h3.4c2.1,0,3.7,1.2,3.7,3.6
                                                  c0,2.5-1.6,3.7-3.7,3.7H19.5z M19.5,8.2v3.6h2.2c1.1,0,1.8-0.7,1.8-1.8c0-1.2-0.7-1.8-1.8-1.8C21.7,8.2,19.5,8.2,19.5,8.2z"/>
                                          </g>
                                      </g>
                                  </g>
                              </svg>
                          </div>
                          <div class="progress-text">
                            <div class="current-progress">
                              [[progress.current]]
                            </div>
                            <div class="required-progress">
                              / [[progress.total]]
                            </div>
                          </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'kano-user-summary',
        properties: {
            /**
             * Source of the user's avatar or the default avatar
             */
            avatar: {
                type: String,
                computed: '_computeAvatar(user)',
                readOnly: true,
                notify: true
            },
            /**
             * Fallback image to display
             */
            defaultAvatar: {
                type: String,
                value: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'
            },
            /**
             * User level computed from the XP
             */
            level: {
                type: Number,
                computed: '_computeLevel(xp)',
                readOnly: true,
                notify: true
            },
            /**
             * Current progress of the user fomr 0 to 1 until the next level
             */
            progress: {
                type: Number,
                computed: '_computeProgress(xp)',
                readOnly: true,
                notify: true
            },
            /**
             * The Kano World User object
             */
            user: {
                type: Object
            },
            /**
             * User XP computed from the user object
             */
            xp: {
                type: Number,
                computed: '_computeXP(user)',
                readOnly: true,
                notify: true
            }
        },
        created () {
            this.levelsMap = {
                0: 0,
                1: 20,
                2: 30,
                3: 40,
                4: 70,
                5: 120,
                6: 200,
                7: 330,
                8: 550,
                9: 900,
                10: 1480,
                11: 2450,
                12: 4030,
                13: 6650,
                14: 10970,
                15: 18080,
                16: 29810,
                17: 49150,
                18: 81030,
                19: 133600,
                20: 220260
            }
        },
        _computeAvatar(user) {
            if (user && user.avatar && user.avatar.urls) {
                return user.avatar.urls.circle || this.defaultAvatar;
            }
            return this.defaultAvatar;
        },
        _computeLevel (xp) {
            var current = 0,
                lvl;
            if (typeof xp !== 'number') {
                return null;
            }
            for (lvl in this.levelsMap) {
                if (xp < this.levelsMap[lvl]) {
                    return parseInt(current);
                }
                current = lvl;
            }
            return parseInt(current);
        },
        _computeProgress (xp) {
            var progress = this._progressFromXp(xp),
                levelCurrent = progress.levelCurrent,
                levelTotal = progress.levelTotal,
                percentageProgress = (levelCurrent * 100) / levelTotal;
            return {
                current: levelCurrent,
                total: levelTotal,
                percentage: parseInt(percentageProgress)
            }
        },
        _computeProgressBarStyle (progress) {
            return 'width: ' + progress.percentage + '%';
        },
        _computeProgressOverlayStyle (progress) {
            return 'left: ' + progress.percentage + '%;';
        },
        _computeXP (user) {
            return user && user.profile && user.profile.xp || 0;
        },
        _progressFromXp (xp) {
            var last = 0,
                lvl;
            for (lvl in this.levelsMap) {
                if (xp < this.levelsMap[lvl]) {
                    return {
                        levelCurrent: xp - last,
                        levelTotal: this.levelsMap[lvl] - last
                    };
                }
                last = this.levelsMap[lvl];
            }
            return {
                levelCurrent: 0,
                levelTotal: 1
            };
        }
    });
</script>
