<script>
(function (Kano) {

    Kano.Behaviors = Kano.Behaviors || {};
    Kano.Behaviors.Gamification = {
        properties: {
            config: {
                type: Object
            },
            context: {
                type: Object
            },
            token: {
                type: String
            }
        },
        listeners: {
            'gamification-event': '_saveGamificationEvent'
        },
        ready () {
            this.context = Kano.World || Kano.App || {};
            this.config = this.config || this.context.config;
            if (!this.config && !this.context.initialized) {
                console.warn('No Kano configuration:\nPlease import a Kano.World or Kano.App config Object to use the API');
            }
            this.context.initialized = true;
        },
        _saveGamificationEvent (e) {
            if (!this.token || !e.detail || !e.detail.name || !e.detail.detail) {
                return;
            }
            let headers = new Headers({
                'Authorization': this.token,
                'Content-Type': 'application/json'
            });
            fetch(this.config.API_URL + '/progress/', {
                method: 'POST',
                headers,
                body: JSON.stringify(e.detail)
            })
            .then(response => response.json())
            .then(response => {
                this._trackGamificationEvent(response.update);
            })
            .catch(err => {});
        },
        _trackGamificationEvent (update) {
            let badgesAwarded = [],
                badgeTest = new RegExp('badges-.*');
            for (let category in update) {
                let isBadge = badgeTest.test(category),
                    badgeAwarded = update[category].changes
                                   && update[category].changes.new;
                if (isBadge && badgeAwarded) {
                    update[category].changes.new.forEach(badge => {
                        badgesAwarded.push(badge);
                    });
                }
            }
            if (badgesAwarded.length) {
                badgesAwarded.forEach(badge => {
                    this.fire('tracking-event', {
                        name: 'badge_unlocked',
                        data: {
                            badge_id: badge.id,
                            badge_name: badge.title
                        }
                    });
                });
            }
        }
    }

})(window.Kano = window.Kano || {});
</script>
