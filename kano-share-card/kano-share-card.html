<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-image/iron-image.html">
<link rel="import" href="../kano-api-client-behavior/kano-api-client-behavior.html">
<link rel="import" href="../kano-share-stats/kano-share-stats.html">
<link rel="import" href="../kano-style/typography.html">
<link rel="import" href="../kano-style/color.html">
<link rel="import" href="../kano-style/button.html">
<dom-module id="kano-share-card">
    <template>
        <style>
            *:host {
                box-sizing: border-box;
            }
            :host .wrapper {
                align-items: stretch;
                padding: 20px 0;
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }
            :host .cover {
                height: 170px;
                width: 240px;
            }
            :host .content {
                padding: 30px 0;
                @apply(--layout-flex);
                @apply(--layout-vertical);
                @apply(--layout-justified);
                @apply(--layout-start);
            }
            :host .details {
                width: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-start);
            }
            :host .text {
                @apply(--layout-flex);
                padding-left: 15px;
            }
            :host .avatar {
                height: 50px;
                width: 50px;
            }
            :host .title {
                margin: 0 0 5px 0;
                padding: 0;
            }
            :host .credit {
                color: var(--color-grey-light);
                font-size: 0.8em;
                font-weight: normal;
                margin: 0;
                padding: 0;
            }
            :host .user {
                font-weight: bold;
            }
            :host .meta  {
                width: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-justified);
                @apply(--layout-center);
            }
            :host .content {
                padding-left: 20px;
            }
            :host .button {
                -webkit-appearance: none;
                appearance: none;
                background-color: #ffffff;
                border: 0;
                cursor: pointer;
                font-family: 'Bariol', sans-serif;
                font-size: 0.8em;
                font-weight: bold;
                padding: 30px 0;
            }
            :host .button:focus {
                outline: none;
            }
            :host .button.kit {
                background-color: #858c90;
                border-radius: 3px;
                color: #ffffff;
                padding: 8px 20px 8px;
                text-shadow: 0px 1.5px rgba(0, 0, 0, 0.25);
            }
            :host([tombstone]) .cover {
                background: var(--color-grey-light);
                color: transparent;
            }
            :host([tombstone]) .avatar {
                background: var(--color-grey-light);
                border-radius: 100%;
                color: transparent;
            }
            :host([tombstone]) .title {
                width: 50%;
                height: 20px;
                background-color: var(--color-grey-light);
                color: transparent;
            }
            :host([tombstone]) .credit {
                width: 30%;
                height: 20px;
                background: var(--color-grey-light);
                color: transparent;
            }
        </style>
        <kano-session token="{{token}}" user="{{user}}"></kano-session>
        <div class="wrapper">
            <iron-image id="cover" class="cover" src="[[share.cover_url]]" sizing="contain" preload fade></iron-image>
            <div class="content">
                <div class="details">
                    <iron-image class="avatar"
                                src="[[_computeAvatar(share)]]"
                                sizing="contain"
                                preload
                                fade></iron-image>
                    <div class="text">
                        <h3 class="title">[[share.title]]</h3>
                        <h4 class="credit">Created by <span class="user">[[share.user.username]]</span></h4>
                    </div>
                </div>
                <div class="meta">
                    <kano-share-stats id="stats"
                                      likes="[[numberOfLikes]]"
                                      liked="[[liked]]"
                                      comments="[[share.comments_count]]"
                                      tombstone$="[[!share]]"
                                      on-like-action="_toggleLike"
                                      on-remix-action="_remix">
                                      </kano-share-stats>
                    <button class="button kit" on-tap="_sendToKit">
                        <iron-icon class="icon" icon="kano-icons:send-to-device"></iron-icon>
                        Send to Kit
                    </button>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'kano-share-card',
            behaviors: [
                Kano.APIClient,
            ],
            properties: {
                liked: {
                    type: Boolean,
                    notify: true,
                    value: null
                },
                numberOfLikes: {
                    type: Number,
                    value: 0
                },
                share: {
                    type: Object,
                    notify: true
                }
            },
            observers: [
                '_checkLikes(share.*, user)'
            ],
            _computeAvatar(share) {
                if (!share) {
                    return;
                }
                return share.user.avatar.urls.circle || '../static/avatar/judoka-face.svg';
            },
            _checkLikes () {
                if (this.share) {
                    this.set('numberOfLikes', this.share.likes.length);
                    if (this.user) {
                        let liked = this.share.likes.some((like) => {
                            return like.user === this.user.id;
                        })
                        return this.set('liked', liked);
                    } else {
                        return this.set('liked', false)
                    }
                }
            },
            _remix (e){
                let item = this.share;
                this.fire('remix', {
                    id: item.id,
                    slug: item.slug,
                    type: item.app
                });
            },
            _removeLike () {
                this.share.likes.forEach((like, index) => {
                    if (like.user === this.user.id) {
                        this.splice('share.likes', index, 1);
                    }
                });
            },
            _sendToKit () {
                this.fire('send-to-kit', this.share);
            },
            _toggleLike (e, liked) {
                let method = liked ? 'POST' : 'DELETE';
                if (this.user) {
                    this.set('liked', liked);
                    let headers = new Headers({
                        'Authorization': this.token,
                        'Content-Type': 'application/json'
                    });
                    fetch(this._getUrl('like-share', { id: this.share.id }), {
                        method,
                        headers
                    })
                    .then((response) => response.json())
                    .then((response) => {
                        if (response.success) {
                            if (response.item) {
                                this.push('share.likes', response.item);
                            } else {
                                this._removeLike();
                            }
                        }
                    })
                    .catch((err) => {
                        this.set('liked', !liked);
                    })
                } else {
                    this.fire('login');
                }
            }
        });
    </script>
</dom-module>
