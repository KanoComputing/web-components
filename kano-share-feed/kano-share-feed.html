<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../iron-list/iron-list.html">
<link rel="import" href="../../iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../kano-api-client-behavior/kano-api-client-behavior.html">
<link rel="import" href="../kano-share-card/kano-share-card.html">
<link rel="import" href="../kano-style/kano-style.html">

<dom-module id="kano-share-feed">
    <template>
        <style>
            :host * {
                box-sizing: border-box;
            }
            :host {
                display: block;
                position: relative;
                overflow: hidden;
                @apply --layout-vertical;
            }
            :host .feed {
                display: block;
                min-height: 470px;
                overflow: hidden;
                position: relative;
                @apply --layout-vertical;
            }
            :host .feed[hidden] {
                display: none;
            }
            :host .placeholder {
                @apply --layout-horizontal;
                @apply --layout-justified;
                @apply --layout-wrap;
                height: 100%;
                width: 100%;
                transition: opacity linear 200ms;
                margin: 20px;
            }
            @keyframes fade-in {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            kano-share-card {
                animation: fade-in linear 200ms;
            }
            :host .message {
                color: var(--color-battleship-grey);
                margin: auto;
                max-width: var(--content-width);
            }
        </style>
        <template is="dom-if" if="[[empty]]">
            <div class="message">
                <slot id="placeholder" name="placeholder"> </slot>
            </div>
        </template>
        <div class$="feed [[mode]]">
            <iron-scroll-threshold id="threshold"
                                   lower-threshold="1000"
                                   on-lower-threshold="_loadMoreData"
                                   scroll-target="document">
                <iron-list id="list"
                           items="[[shares]]"
                           as="share"
                           grid
                           scroll-target="document">
                    <template>
                        <kano-share-card id$="[[share.slug]]"
                                         assets-path="[[assetsPath]]"
                                         device="[[device]]"
                                         mode="[[mode]]"
                                         share="[[share]]">
                                         </kano-share-card>
                    </template>
                </iron-list>
                <template is="dom-if" if="[[empty]]">
                    <div class="placeholder">
                        <kano-share-card share
                                         tombstone
                                         assets-path="[[assetsPath]]"
                                         mode="[[mode]]">
                                         </kano-share-card>
                        <kano-share-card share
                                         tombstone
                                         assets-path="[[assetsPath]]"
                                         mode="[[mode]]">
                                         </kano-share-card>
                        <kano-share-card share
                                         tombstone
                                         assets-path="[[assetsPath]]"
                                         mode="[[mode]]">
                                         </kano-share-card>
                        <kano-share-card share
                                         tombstone
                                         assets-path="[[assetsPath]]"
                                         mode="[[mode]]">
                                         </kano-share-card>
                        <kano-share-card share
                                         tombstone
                                         assets-path="[[assetsPath]]"
                                         mode="[[mode]]">
                                         </kano-share-card>
                        <kano-share-card share
                                         tombstone
                                         assets-path="[[assetsPath]]"
                                         mode="[[mode]]">
                                         </kano-share-card>
                        <template is="dom-if" if="[[isDetailed]]">
                            <kano-share-card share
                                             tombstone
                                             assets-path="[[assetsPath]]"
                                             mode="[[mode]]">
                                             </kano-share-card>
                        </template>
                    </div>
                </template>
            </iron-scroll-threshold>
        </div>
    </template>
    <script>
        Polymer({
            is: 'kano-share-feed',
            behaviors: [Kano.APIClient],
            properties: {
                /**
                * App name to allow filtering of shares by app
                */
                app: {
                    type: String,
                    value: null,
                    observer: '_handleChanges'
                },
                assetsPath: {
                    type: String,
                    value: '/'
                },
                assetsPath: {
                    type: String,
                    value: '/assets'
                },
                /**
                * Device/kit for comparing share's compatibility
                */
                device: {
                    type: String
                },
                empty: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                /**
                * Boolean to restrict results only to staff picks
                */
                featured: {
                    type: Boolean,
                    value: false
                },
                /**
                * String to determine whether to fetch shares or activity feed
                */
                feed: {
                    type: String,
                    value: 'feed'
                },
                isDetailed: {
                    type: Boolean,
                    computed: '_isDetailed(mode)'
                },
                /**
                * String to determine the layout of the cards
                */
                mode: {
                    type: String,
                    value: 'detailed'
                },
                shares: {
                    type: Array,
                    value: () => {
                        return [];
                    }
                },
                /**
                * User ID to allow for filtering of shares by user
                */
                userId: {
                    type: String,
                    value: null,
                    observer: '_handleChanges'
                }
            },
            attached () {
                if (!this.initialized) {
                    this.set('page', 0);
                }
                this.set('initialized', true);
            },
            _handleChanges () {
                if (this.populated) {
                    this._reset();
                }
            },
            _loadMoreData () {
                // When we hit the last page
                if (this.page === null) {
                    return;
                }
                this.set('fetching', true);
                let self = this,
                    feedType = this.feed,
                    limit = this.mode === 'detailed' ? 18 : 20,
                    query = [
                        `page=${this.page}`,
                        `limit=${limit}`
                    ],
                    queryString;
                if (this.userId) {
                    query.push(`user_id=${this.userId}`);
                }
                if (this.app) {
                    query.push(`app_name=${this.app}`);
                }
                if (this.featured) {
                    query.push('featured=true');
                }
                queryString = query.join('&');
                fetch(`${this._getUrl(feedType)}?${queryString}`)
                    .then(r => r.json())
                    .then(r => {
                        if (r.entries.length) {
                            r.entries.forEach(share => {
                                if (share) {
                                    let item;
                                    if (feedType === 'activity-feed') {
                                        item = share.item;
                                    } else {
                                        item = share;
                                    }
                                    this.push('shares', item);
                                }
                            });
                            this.set('page', r.next);
                            this.set('populated', true);
                            this.set('empty', false);
                        } else {
                            this.set('empty', true);
                        }
                        this.set('fetching', false);
                        this.$.threshold.clearTriggers();
                    });
            },
            _isDetailed (mode) {
                return mode === 'detailed';
            },
            _reset () {
                this.set('populated', false);
                this.set('shares', []);
                this.set('page', 0);
                this.set('selectedShare', {});
                this._loadMoreData();
            }
        });
    </script>
</dom-module>
