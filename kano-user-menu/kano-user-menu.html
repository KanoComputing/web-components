<link rel="import" href="../../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../kano-user-summary/kano-user-summary.html">
<link rel="import" href="../kano-drop-down-item/kano-drop-down-item.html">
<link rel="import" href="../kano-notifications/kano-notifications.html">
<link rel="import" href="../kano-user-badge/kano-user-badge.html">
<link rel="import" href="../kano-drop-down/kano-drop-down.html">
<link rel="import" href="../kano-icons/kano-icons.html">
<link rel="import" href="../kano-style/color.html">

<!--
Example:

    <kano-user-menu assets-path="../assets/icons/"
                    default-avatar="../assets/avatar.png"
                    user="[[user]]"
                    xp="100"></kano-user-menu>

@group Kano Elements

-->

<dom-module id="kano-user-menu">
    <style>
        *[hidden] {
            display: none !important;
        }
        :host * {
            box-sizing: border-box;
        }
        :host {
            position: relative;
            z-index: 100;
        }
        :host nav {
            @apply --layout-flex;
            @apply --layout-vertical;
            background: transparent;
            font-family: var(--kano-user-menu-font-family);
            font-weight: 700;
            display: block;
        }
        :host ul {
            list-style: none;
            margin: 0px;
            padding: 0px;
        }
        :host .kano-user-nav,
        :host .auth-menu,
        :host .user-menu {
            height: 100%;
            min-height: 60px;
            width: 100%;
        }
        :host .kano-user-nav,
        :host .username {
            @apply --layout-flex;
            @apply --layout-horizontal;
            @apply --layout-justified;
        }
        :host .user-menu,
        :host .auth-menu {
            @apply --layout-flex;
            @apply --layout-horizontal;
            @apply --layout-end-justified;
        }
        :host .menu-item {
            cursor: pointer;
            position: relative;
            @apply --layout-horizontal;
            -webkit-tap-highlight-color: transparent;
        }
        :host .menu-button {
            background-color: transparent;
            background: transparent;
            border: 0px;
            box-shadow: none;
            color: #a0a4a8;
            cursor: pointer;
            font-family: var(--kano-user-menu-font-family);
            font-size: 18px;
            font-weight: normal;
            height: 100%;
            margin: 0px;
            padding: 0px;
            text-transform: none;
            width: 100%;
        }
        :host .auth-menu .menu-button {
            @apply --layout-flex;
            @apply --layout-vertical;
            @apply --layout-center-justified;
        }
        :host .menu-button:focus {
            outline: 0;
        }
        :host #notifications-button, :host #settings-button {
            padding: 0px 20px;
        }
        :host #user-button {
            padding: 10px 0px 10px 20px;
        }
        :host #notifications-button .button-items, 
        :host #settings-button .button-items,
        :host #user-button .button-items {
            @apply --layout-center;
            @apply --layout-flex;
            @apply --layout-horizontal;
            @apply --layout-justified;
            height: 100%;
        }
        :host #user-button .username {
            margin-left: 12px;
            font-weight: 400;
            color: #414042;
        }
        :host .menu-item.avatar>.link:focus {
            background-color: #eeeeee;
        }
        :host .menu-item.notifications>.link:focus, 
        :host .menu-item.settings>.link:focus {
            transform: scale(1.3);
            background-color: transparent;
        }
        :host .menu-item a {
            @apply --layout-flex;
            color: #a0a4a8;
            text-align: center;
            font-family: var(--kano-user-menu-font-family);
            font-size: 18px;
            font-weight: normal;
        }
        :host .drop-down-content {
            padding: 15px 0px;
            font-size: 15px;
        }
        :host #notifications-menu, 
        :host #settings-menu {
            @apply --layout-horizontal;
            @apply --layout-center;
            @apply --layout-center-justified;
        }
        :host kano-drop-down {
            padding: 15px;
            position: absolute;
            top: 100%;
        }
        :host {
            --kano-drop-down: {
                padding: 5px;
                right: 0px;
                width: 100%;
                @apply --kano-box-shadow;
            }
        }
        .notifications-icon {
            height: 20px;
        }
        :host #notifications-drop-down {
            right: -12.5px;
        }
        :host #user-drop-down {
            right: 5px;
            width: 200px;
        }
        kano-user-badge {
            --kano-user-badge-progress-color: #ff842a;
        }
        :host .unread-count {
            position: absolute;
            display: inline-block;
            border: 2px solid #fff;
            line-height: 16px;
            text-align: center;
            background-color: #fc823f;
            color: #fff;
            top: 20px;
            right: 0px;
            margin-left: 5px;
            margin-top: -16px;
            font-weight: bold;
            font-size: 0.7em;
            padding: 0 2px;
            min-width: 10px;
            border-radius: 5px;
            pointer-events: none;
        }
        :host a.item {
            text-decoration: none;
            margin: 15px;
        }
        :host .kano-user-nav.red .auth-menu > .menu-item > .menu-button {
            color: #ffffff;
        }
        :host .kano-user-nav.white .auth-menu > .menu-item > .menu-button {
            color: #a7a7a7;
        }
        :host .kano-user-nav.red iron-icon {
            color: #ffffff;
        }
        :host .kano-user-nav.white iron-icon {
            color: #a7a7a7;
        }
        :host .progress-prefix {
            display: inline-block;
            padding-left: 15px;
        }
        :host .prefix-icon {
            width: 20px;
        }
        :host .icon-light {
            fill: #ffb300;
        }
        :host .icon-dark {
            fill: #b37e00;
        }
        :host .xp-status {
            @apply --layout-horizontal;
            @apply --layout-center-justified;
            border-bottom: 1px solid #eaeaea;
        }
        :host .xp-status:hover {
            background: #fff;
        }
        :host .progress-text {
            display: inline-flex;
            line-height: 1em;
            padding-left: 10px;
            text-align: left;
        }
        :host .current-progress {
            color: #a0a4a8;
            font-size: 18px;
        }
        :host .required-progress {
            color: #d4d6d8;
            font-size: 18px;
        }
        @media screen and (max-width: 960px) {
            :host #user-button .username {
                display: none;
            }
        }
        @media screen and (max-width: 768px) {
            :host .separator {
                @apply --layout-self-stretch;
                height: 3px;
                width: auto;
                margin: 20px 39px;
            }
            :host li.menu-item {
                @apply --layout-wrap;
                width: auto;
                box-sizing: border-box;
            }
            :host .link {
                color: #44423d;
                margin: 0px;
                padding: 20px;
                text-align: left;
            }
            :host .auth-menu .menu-button {
                padding: 0px 5px;
            }
            :host {
                --kano-drop-down: {
                    padding: 0px;
                    right: 0px;
                    width: 100%;
                }
            }
            :host #notifications-button, 
            :host #settings-button {
                padding: 0px 10px;
            }
            :host #user-button {
                padding: 10px 10px;
            }
            :host #notifications-button:hover, 
            :host #settings-button:hover,
            :host #user-button:hover {
                border-left-color: transparent;
            }
            :host .drop-down-content {
                background-color: #eee;
            }
            :host kano-drop-down {
                position: relative;
                width: 100%;
            }
            :host #notifications-drop-down {
                position: absolute;
                top: 56px;
                right: -10px;
                width: 250px;
            }
            :host #user-drop-down {
                position: absolute;
                top: 56px;
                right: 0px;
            }
            :host #notifications-drop-down #caret {
                right: 10px;
            }
        }
        @media all and (min-width: 768px) {
            :host .auth-menu .menu-button {
                padding: 0px 20px;
            }
            :host #notifications-drop-down {
                width: 360px;
            }
        }
    </style>
    <template>
        <nav id="kano-user-nav" class$="[[_computeNavClass(colorScheme)]]">
            <ul class="user-menu" hidden$="[[!_isAuthenticated(user)]]">
                <li id="notifications-menu" class="menu-item notifications">
                    <div class="link menu-button" id="notifications-button" on-tap="_toggleOpen">
                        <div class="button-items">
                            <iron-icon icon="kano-icons:notification"></iron-icon>
                        </div>
                    </div>
                    <div class="unread-count" hidden$="[[!unread]]">[[unread]]</div>
                    <kano-drop-down id="notifications-drop-down" caret-align="right" on-tap="_hideDropdown">
                        <kano-notifications mode="[[mode]]" notifications="{{notifications}}" on-notifications-read="_onRead" on-notifications-read-all="_onReadAll" unread-count="{{unread}}" world-root="[[worldRoot]]" username="[[user.username]]"></kano-notifications>
                    </kano-drop-down>
                </li>
                <li id="avatar-menu" class="menu-item avatar">
                    <div class="link menu-button" id="user-button" on-tap="_toggleOpen">
                        <div class="button-items">
                            <template is="dom-if" if="[[userSummary]]">
                                <kano-user-summary user="[[user]]"
                                                   level="{{level}}"
                                                   default-avatar="{{defaultAvatar}}"
                                                   color-scheme="[[colorScheme]]"></kano-user-summary>
                            </template>
                            <template is="dom-if" if="[[!userSummary]]">
                                <kano-user-badge user="[[user]]" xp="[[xp]]" level="{{level}}" default-avatar="{{defaultAvatar}}" radius="40" stroke-width="4"></kano-user-badge>
                                <span class="username">[[user.username]]</span>
                            </template>
                        </div>
                    </div>
                    <kano-drop-down id="user-drop-down" on-tap="_hideDropdown">
                        <ul>
                            <kano-drop-down-item class="xp-status">
                                <div class="progress-prefix">
                                    <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                         viewBox="0 0 31.3 24.6" style="enable-background:new 0 0 31.3 24.6;" xml:space="preserve" class="prefix-icon">
                                        <g>
                                            <g>
                                                <path class="icon-light" d="M27.6,0H3.7C1.7,0,0,1.7,0,3.7v17.1c0,2.1,1.7,3.7,3.7,3.7h23.9c2.1,0,3.7-1.7,3.7-3.7V3.7
                                                    C31.3,1.7,29.7,0,27.6,0z"/>
                                                <g>
                                                    <path class="icon-dark" d="M11.6,14l-2.7,4.1c-0.2,0.3-0.5,0.5-0.9,0.5c-0.6,0-1-0.5-1-1c0-0.2,0.1-0.4,0.2-0.6l3.3-4.7L7.4,7.9
                                                        C7.2,7.7,7.2,7.5,7.2,7.3c0-0.6,0.5-1,1-1c0.4,0,0.6,0.1,0.8,0.4l2.5,3.8L14,6.7c0.2-0.3,0.5-0.4,0.8-0.4c0.6,0,1,0.5,1,1
                                                        c0,0.2-0.1,0.4-0.2,0.6l-3.1,4.4l3.3,4.7c0.1,0.1,0.2,0.3,0.2,0.6c0,0.6-0.5,1-1,1c-0.4,0-0.6-0.2-0.9-0.5L11.6,14z"/>
                                                    <path class="icon-dark" d="M19.5,13.7v3.8c0,0.6-0.5,1-1,1s-1-0.5-1-1V7.4c0-0.6,0.5-1,1-1h3.4c2.1,0,3.7,1.2,3.7,3.6
                                                        c0,2.5-1.6,3.7-3.7,3.7H19.5z M19.5,8.2v3.6h2.2c1.1,0,1.8-0.7,1.8-1.8c0-1.2-0.7-1.8-1.8-1.8C21.7,8.2,19.5,8.2,19.5,8.2z"/>
                                                </g>
                                            </g>
                                        </g>
                                    </svg>
                                </div>
                                <div class="progress-text">
                                    <div class="current-progress">
                                        [[progress.current]]
                                    </div>
                                    <div class="required-progress">
                                        / [[progress.total]]
                                    </div>
                                </div>
                            </kano-drop-down-item>
                            <a href$="[[worldRoot]]/users/[[user.username]]" class="item menu-button" on-tap="_onProfile">
                                <kano-drop-down-item>
                                    [[user.username]]
                                </kano-drop-down-item>
                            </a>
                            <a href$="[[worldRoot]]/accounts/settings" class="item" on-tap="_onSettings">
                                <kano-drop-down-item>Settings</kano-drop-down-item>
                            </a>
                            <a href$="[[worldRoot]]/admin" class="item" hidden$="[[!_isUserAdmin(user)]]">
                                <kano-drop-down-item>Admin</kano-drop-down-item>
                            </a>
                            <button class="item menu-button" on-tap="_onLogout">
                                <kano-drop-down-item>Log out</kano-drop-down-item>
                            </button>
                        </ul>
                    </kano-drop-down>
                </li>
                <li id="settings-menu" class="menu-item settings">
                    <div class="link menu-button" id="settings-button" on-tap="_onSettings">
                        <div class="button-items">
                            <iron-icon icon="kano-icons:settings"></iron-icon>
                        </div>
                    </div>
                </li>
            </ul>
            <ul class="auth-menu" hidden$="[[_isAuthenticated(user)]]">
                <li class="menu-item">
                    <div class="menu-button" on-tap="_login">Log in</div>
                </li>
                <li class="menu-item">
                    <div class="menu-button" on-tap="_signup">Sign up</div>
                </li>
            </ul>
        </nav>
    </template>
</dom-module>
<script type="text/javascript">
    Polymer({
        is: 'kano-user-menu',
        properties: {
            /**
             * The current color-scheme required
             */
            colorScheme: {
                type: String,
                value: 'black'
            },
            /**
             * Whether the menu should use online or in-app behavior
             */
            mode: {
                type: String,
                value: 'online'
            },
            /**
             * Basepath of the site to allow for testing across multiple environments
             */
            siteRoot: {
                type: String,
                value: 'https://kano.me'
            },
            /**
             * User object containing the information about the authenticated user
             */
            user: {
                type: Object,
                value: null
            },
            /**
             * Amount of experience earned by the authenticated user
             */
            xp: {
                type: Number,
                readOnly: true,
                notify: true,
                value: 0
            },
            /**
             * A list of notifications received by the authenticated user
             */
            notifications: {
                type: Array,
                notify: true
            },
            /**
             * Path to the assets required by this components
             */
            assetsPath: {
                type: String,
                value: '/'
            },
            /**
             * Base path of Kano World. You can use this to test redirections to staging/dev environments
             */
            worldRoot: {
                type: String,
                value: 'https://world.kano.me'
            },
            /**
             * Default avatar for the user badge
             */
            defaultAvatar: {
                type: String
            },
            /**
             * Temporary property to allow component switching for development
             */
            userSummary: {
                type: Boolean,
                value: false
            },
            progress: {
                type: Number,
                computed: '_computeProgress(xp)',
                readOnly: true,
                notify: true,
                value: 0
            },
        },
        created () {
            this.levelsMap = {
                0: 0,
                1: 20,
                2: 30,
                3: 40,
                4: 70,
                5: 120,
                6: 200,
                7: 330,
                8: 550,
                9: 900,
                10: 1480,
                11: 2450,
                12: 4030,
                13: 6650,
                14: 10970,
                15: 18080,
                16: 29810,
                17: 49150,
                18: 81030,
                19: 133600,
                20: 220260
            }
        },
        attached () {
            this.listen(document, 'tap', '_closeDropdowns');
            console.log(this.progress, this.xp);
        },
        detached () {
            this.unlisten(document, 'tap', '_closeDropdowns');
        },
        _progressFromXp (xp) {
            var last = 0,
                lvl;
            for (lvl in this.levelsMap) {
                if (xp < this.levelsMap[lvl]) {
                    return {
                        levelCurrent: xp - last,
                        levelTotal: this.levelsMap[lvl] - last
                    };
                }
                last = this.levelsMap[lvl];
            }
            return {
                levelCurrent: 0,
                levelTotal: 1
            };
        },
        _computeProgress (xp) {
            var progress = this._progressFromXp(xp),
                levelCurrent = progress.levelCurrent,
                levelTotal = progress.levelTotal,
                percentageProgress = (levelCurrent * 100) / levelTotal;
            return {
                current: levelCurrent,
                total: levelTotal,
                percentage: parseInt(percentageProgress)
            }
        },
        _computeXP (user) {
            return user && user.profile && user.profile.xp || 0;
        },
        _computeNavClass (color) {
            var baseClass = 'kano-user-nav',
                activeClass = color;
            return baseClass + ' ' + color;
        },
        _isAuthenticated (user) {
            return !!user;
        },
        _closeDropdowns (e) {
            var dropDowns = Polymer.dom(this.root).querySelectorAll('kano-drop-down');
            for (var i = 0; i < dropDowns.length; i++) {
                dropDowns[i].close();
            }
        },
        _onRead (e) {
            this.fire('read', {notification: e.detail});
        }, 
        _onReadAll (e) {
            this.fire('read-all', {notification: e.detail});
        },
        _login () {
            this.fire('login');
        },
        _onLogout () {
            this.fire('logout');
        },
        _signup () {
            this.fire('signup');
        },
        _onProfile (e) {
            if (this.mode === 'app') {
                e.preventDefault();
                this.fire('view-profile');
            }
        },
        _onSettings (e) {
            if (this.mode === 'app') {
                e.preventDefault();
                this.fire('view-settings');
            }
        },
        _toggleOpen (e) {
            var target = e.currentTarget;
            var triggerId = target.getAttribute('id'),
                dropDowns = Polymer.dom(this.root).querySelectorAll('kano-drop-down'),
                targetDDId,
                dropDown;

            e.stopPropagation();

            if (!triggerId) {
                target = target.parentNode;
                triggerId = target.getAttribute('id')
            }
            targetDDId = triggerId.replace('-button', '-drop-down');
            dropDown = this.$[targetDDId];

            for (var i = 0; i < dropDowns.length; i++) {
                if (dropDowns[i] !== dropDown) {
                    dropDowns[i].close();
                }
            }
            if (dropDown) {
                dropDown.toggle();
            }
        },
        _isUserAdmin (user) {
            return user && user.admin_level > 0;
        },
        _hideDropdown (e) {
            e.stopPropagation();
            this.menuOpened = false;
            this._closeDropdowns();
        }
    });
</script>
